"use strict";(self.webpackChunkflarum_core=self.webpackChunkflarum_core||[]).push([[698],{1053:(e,s,t)=>{t.r(s),t.d(s,{default:()=>S});var o=t(8805),r=t(3554),a=t(3420),n=t(6064),i=t(592),l=t(5673),c=t(117),u=t(5710),d=t(3092),h=t(4411),A=t(7817),k=t(5114);class g extends u.A{view(e){return m("div",{className:"LabelValue"},m("div",{className:"LabelValue-label"},k.A.translator.trans("core.lib.data_segment.label",{label:this.attrs.label})),m("div",{className:"LabelValue-value"},this.attrs.value))}}flarum.reg.add("core","common/components/LabelValue",g);var f=t(4268),T=t(4391),y=t(7479);class p extends u.A{constructor(){super(...arguments),(0,o.A)(this,"loading",{}),(0,o.A)(this,"showingTokens",{})}view(e){return m("div",{className:"AccessTokensList"},this.attrs.tokens.length?this.attrs.tokens.map(this.tokenView.bind(this)):m("div",{className:"AccessTokensList--empty"},r.A.translator.trans("core.forum.security.empty_text")))}tokenView(e){return m("div",{className:(0,f.A)("AccessTokensList-item",{"AccessTokensList-item--active":e.isCurrent()}),key:e.id()},this.tokenViewItems(e).toArray())}tokenViewItems(e){const s=new n.A;return s.add("icon",m("div",{className:"AccessTokensList-item-icon"},m(y.A,{name:this.attrs.icon||"fas fa-key"})),50),s.add("info",m("div",{className:"AccessTokensList-item-info"},this.tokenInfoItems(e).toArray()),40),s.add("actions",m("div",{className:"AccessTokensList-item-actions"},this.tokenActionItems(e).toArray()),30),s}tokenInfoItems(e){const s=new n.A;return"session"===this.attrs.type?s.add("title",m("div",{className:"AccessTokensList-item-title"},m("span",{className:"AccessTokensList-item-title-main"},e.device()),e.isCurrent()&&[" — ",m("span",{className:"AccessTokensList-item-title-sub"},r.A.translator.trans("core.forum.security.current_active_session"))])):s.add("title",m("div",{className:"AccessTokensList-item-title"},m("span",{className:"AccessTokensList-item-title-main"},this.generateTokenTitle(e)))),s.add("createdAt",m("div",{className:"AccessTokensList-item-createdAt"},m(g,{label:r.A.translator.trans("core.forum.security.created"),value:(0,A.A)(e.createdAt())}))),s.add("lastActivityAt",m("div",{className:"AccessTokensList-item-lastActivityAt"},m(g,{label:r.A.translator.trans("core.forum.security.last_activity"),value:e.lastActivityAt()?m("[",null,(0,A.A)(e.lastActivityAt()),e.lastIpAddress()&&m("span",null," ","— ",m(h.A,{ip:e.lastIpAddress()})),"developer_token"===this.attrs.type&&e.device()&&m("[",null," ","— ",m("span",{className:"AccessTokensList-item-title-sub"},e.device()))):r.A.translator.trans("core.forum.security.never")}))),s}tokenActionItems(e){const s=new n.A,t={session:"terminate_session",developer_token:"revoke_access_token"}[this.attrs.type];if("developer_token"===this.attrs.type){const t=!this.showingTokens[e.id()],o=t?"show_access_token":"hide_access_token";s.add("toggleDisplay",m(d.A,{className:"Button Button--inverted",icon:t?"fas fa-eye":"fas fa-eye-slash",onclick:()=>{this.showingTokens[e.id()]=t,m.redraw()}},r.A.translator.trans(`core.forum.security.${o}`)))}let o=m(d.A,{className:"Button Button--danger",disabled:e.isCurrent(),loading:!!this.loading[e.id()],onclick:()=>this.revoke(e)},r.A.translator.trans(`core.forum.security.${t}`));return e.isCurrent()&&(o=m(T.A,{text:r.A.translator.trans("core.forum.security.cannot_terminate_current_session")},m("div",{tabindex:"0"},o))),s.add("revoke",o),s}async revoke(e){if(!confirm((0,c.A)(r.A.translator.trans("core.forum.security.revoke_access_token_confirmation"))))return;this.loading[e.id()]=!0,await e.delete(),this.loading[e.id()]=!1,this.attrs.ondelete?.(e);const s="session"===this.attrs.type?"session_terminated":"token_revoked";r.A.alerts.show({type:"success"},r.A.translator.trans(`core.forum.security.${s}`,{count:1})),m.redraw()}generateTokenTitle(e){const s=e.title()||r.A.translator.trans("core.forum.security.token_title_placeholder"),t=this.tokenValueDisplay(e);return r.A.translator.trans("core.forum.security.token_item_title",{title:s,token:t})}tokenValueDisplay(e){const s=Array(12).fill("*").join(""),t=this.showingTokens[e.id()]?e.token():s;return m("code",{className:"AccessTokensList-item-token"},t)}}flarum.reg.add("core","forum/components/AccessTokensList",p);var v=t(43),_=t(2855),b=t(4311),w=t(374);class L extends _.A{constructor(){super(...arguments),(0,o.A)(this,"titleInput",(0,b.A)(""))}className(){return"Modal--small NewAccessTokenModal"}title(){return r.A.translator.trans("core.forum.security.new_access_token_modal.title")}content(){const e=r.A.translator.trans("core.forum.security.new_access_token_modal.title_placeholder");return m("div",{className:"Modal-body"},m(w.A,{className:"Form--centered"},m("div",{className:"Form-group"},m("input",{type:"text",className:"FormControl",bidi:this.titleInput,placeholder:e,"aria-label":e})),m("div",{className:"Form-group Form-controls"},m(d.A,{className:"Button Button--primary Button--block",type:"submit",loading:this.loading},r.A.translator.trans("core.forum.security.new_access_token_modal.submit_button")))))}submitData(){return{title:this.titleInput()}}onsubmit(e){super.onsubmit(e),e.preventDefault(),this.loading=!0,r.A.store.createRecord("access-tokens").save(this.submitData()).then((e=>{this.attrs.onsuccess(e),r.A.modal.close()})).finally(this.loaded.bind(this))}}flarum.reg.add("core","forum/components/NewAccessTokenModal",L);class N{constructor(){(0,o.A)(this,"tokens",null),(0,o.A)(this,"loadingTerminateSessions",!1),(0,o.A)(this,"loadingGlobalLogout",!1)}hasLoadedTokens(){return null!==this.tokens}getTokens(){return this.tokens}setTokens(e){this.tokens=e}pushToken(e){this.tokens?.push(e)}removeToken(e){this.tokens=this.tokens.filter((s=>s!==e))}getSessionTokens(){return this.tokens?.filter((e=>e.isSessionToken())).sort(((e,s)=>s.isCurrent()?1:-1))||[]}getDeveloperTokens(){return this.tokens?.filter((e=>!e.isSessionToken()))||null}getOtherSessionTokens(){return this.tokens?.filter((e=>e.isSessionToken()&&!e.isCurrent()))||[]}hasOtherActiveSessions(){return(this.getOtherSessionTokens()||[]).length>0}removeOtherSessionTokens(){this.tokens=this.tokens.filter((e=>!e.isSessionToken()||e.isCurrent()))}}flarum.reg.add("core","forum/states/UserSecurityPageState",N);class S extends a.A{constructor(){super(...arguments),(0,o.A)(this,"state",new N)}oninit(e){super.oninit(e);const s=m.route.param("username");s===r.A.session.user?.slug()||r.A.forum.attribute("canModerateAccessTokens")||m.route.set("/"),this.loadUser(s),r.A.setTitle((0,c.A)(r.A.translator.trans("core.forum.security.title"))),this.loadTokens()}content(){return m("div",{className:"UserSecurityPage"},m("ul",null,(0,l.A)(this.settingsItems().toArray())))}settingsItems(){const e=new n.A;return r.A.forum.attribute("canCreateAccessToken")||r.A.forum.attribute("canModerateAccessTokens")||this.state.hasLoadedTokens()&&this.state.getDeveloperTokens()?.length?e.add("developerTokens",m(i.A,{className:"UserSecurityPage-developerTokens",label:r.A.translator.trans("core.forum.security.developer_tokens_heading")},this.developerTokensItems().toArray())):this.state.hasLoadedTokens()||e.add("developerTokens",m(v.A,null)),e.add("sessions",m(i.A,{className:"UserSecurityPage-sessions",label:r.A.translator.trans("core.forum.security.sessions_heading")},this.sessionsItems().toArray())),this.user.id()===r.A.session.user.id()&&e.add("globalLogout",m(i.A,{className:"FieldSet--col UserSecurityPage-globalLogout",label:r.A.translator.trans("core.forum.security.global_logout.heading"),description:r.A.translator.trans("core.forum.security.global_logout.help_text")},m(d.A,{className:"Button",icon:"fas fa-sign-out-alt",onclick:this.globalLogout.bind(this),loading:this.state.loadingGlobalLogout,disabled:this.state.loadingTerminateSessions},r.A.translator.trans("core.forum.security.global_logout.log_out_button")))),e}developerTokensItems(){const e=new n.A;return e.add("accessTokenList",this.state.hasLoadedTokens()?m(p,{type:"developer_token",ondelete:e=>{this.state.removeToken(e),m.redraw()},tokens:this.state.getDeveloperTokens(),icon:"fas fa-key",hideTokens:!1}):m(v.A,null)),this.user.id()===r.A.session.user.id()&&e.add("newAccessToken",m("div",{className:"UserSecurityPage-controls"},m(d.A,{className:"Button",disabled:!r.A.forum.attribute("canCreateAccessToken"),onclick:()=>r.A.modal.show(L,{onsuccess:e=>{this.state.pushToken(e),m.redraw()}})},r.A.translator.trans("core.forum.security.new_access_token_button")))),e}sessionsItems(){const e=new n.A;if(e.add("sessionsList",this.state.hasLoadedTokens()?m(p,{type:"session",ondelete:e=>{this.state.removeToken(e),m.redraw()},tokens:this.state.getSessionTokens(),icon:"fas fa-laptop",hideTokens:!0}):m(v.A,null)),this.user.id()===r.A.session.user.id()){const s=!this.state.hasOtherActiveSessions();let t=m(d.A,{className:"Button",onclick:this.terminateAllOtherSessions.bind(this),loading:this.state.loadingTerminateSessions,disabled:this.state.loadingGlobalLogout||s},r.A.translator.trans("core.forum.security.terminate_all_other_sessions"));s&&(t=m(T.A,{text:r.A.translator.trans("core.forum.security.cannot_terminate_current_session")},m("span",{tabindex:"0"},t))),e.add("terminateAllOtherSessions",m("div",{className:"UserSecurityPage-controls"},t))}return e}loadTokens(){return r.A.store.find("access-tokens",{filter:{user:this.user.id()}}).then((e=>{this.state.setTokens(e),m.redraw()}))}terminateAllOtherSessions(){if(confirm((0,c.A)(r.A.translator.trans("core.forum.security.terminate_all_other_sessions_confirmation"))))return this.state.loadingTerminateSessions=!0,r.A.request({method:"DELETE",url:r.A.forum.attribute("apiUrl")+"/sessions"}).then((()=>{const e=this.state.getOtherSessionTokens().length;this.state.removeOtherSessionTokens(),r.A.alerts.show({type:"success"},r.A.translator.trans("core.forum.security.session_terminated",{count:e}))})).catch((()=>{r.A.alerts.show({type:"error"},r.A.translator.trans("core.forum.security.session_termination_failed"))})).finally((()=>{this.state.loadingTerminateSessions=!1,m.redraw()}))}globalLogout(){return this.state.loadingGlobalLogout=!0,r.A.request({method:"POST",url:r.A.forum.attribute("baseUrl")+"/global-logout"}).then((()=>window.location.reload())).finally((()=>{this.state.loadingGlobalLogout=!1,m.redraw()}))}}flarum.reg.add("core","forum/components/UserSecurityPage",S)}}]);
//# sourceMappingURL=UserSecurityPage.js.map